{% extends "base.html" %}
{% load static %}
{% block block_title %}{{ directory.name }} | 目录{% endblock %}

{% block block_css %}
<link rel="stylesheet" href="{% static '/bootstrap/css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static '/bootstrap-icons/bootstrap-icons.css' %}">
<link rel="stylesheet" href="{% static '/Notebook/css/notebook_theme.css' %}">
<style>
    .choosed-postion{color:white;background-color: rgb(0, 124, 77);}
    .choosed-postion i{color:white;background-color: rgb(0, 124, 77);}
</style>
{% endblock %}

{% block block_content %}

<!-- 顶部工具栏 -->
<div class="sticky-top bg-light border-bottom">
    <div class="container">
        <div class="row">
            <nav class="navbar navbar-light ">
                <a href="{% url 'Notebook_directory' %}" class="col-2 text-start ps-2">
                    <i class="text-success bi bi-arrow-left-short" style="font-size: 1.5rem;"></i>
                    <i class="text-success bi bi-inboxes" style="font-size: 1.5rem;"></i>
                </a>
                <span class="col-8 h5 text-center" style="margin: 0px;">{{ directory.name }}</span>
                <a data-bs-toggle="offcanvas" href="#toolbarBottom" class="col-2 text-end pe-2">
                    <i class="text-success bi bi-gear-wide-connected" style="font-size: 1.5rem;"></i>
                </a>
            </nav>
        </div>
    </div>
</div>

<!-- 子目录、笔记列表 -->
<div class="container">
    <div class="row">
        <div class="col">
            <nav>
                <ol class="breadcrumb ms-2 mt-2">
                    <li class="breadcrumb-item"><a href="{% url 'Notebook_directory' %}">{{ user.username }}</a></li>
                    {% if directory_parents %}
                        {% for dir in directory_parents %}
                            {% if forloop.counter0 == 0 %}
                            {% else %}
                                <li class="breadcrumb-item"><a href="{% url 'Notebook_directory_notelist' dir.id %}">{{ dir.name }}</a></li>
                            {% endif%}
                        {% endfor %}
                    {% endif %}
                    <li class="breadcrumb-item active" aria-current="page">{{ directory.name }}</li>
                </ol>
            </nav>
        </div>
    </div>
    <div class="row">
        <form class="col">
            <input class="form-control" type="search" placeholder="搜索笔记..." aria-label="Search">
        </form>
    </div>
    {% if directory_children %}
    <h4 class="mt-3 row"><span class="col">子目录</span></h4>
    <div class="row mt-3">
        <div class="col">
            <ul class="list-group">
                    {% for dir in directory_children %}
                    <a href="{% url 'Notebook_directory_notelist' dir.id %}" class="list-group-item list-group-item-action">
                        <i class="bi bi-journal-text"></i>
                        <span class="col align-self-center">{{ dir.name }}</span>
                    </a>
                    {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
    <h4 class="mt-3 row"><span class="col">笔记</span></h4>
    {% if notes_pintop or notes_not_pintop %}
        <div class="row mt-3">
            <div class="col">
                <ul class="list-group">
                    {% for note in notes_pintop %}
                        {% include 'Notebook/directory/notelist_note_listitem.html' with note=note %}
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <ul class="list-group">
                    {% for note in notes_not_pintop %}
                        {% include 'Notebook/directory/notelist_note_listitem.html' with note=note %}
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% else %}
        <div class="row mt-3">
            <small class="text-secondary text-center col mt-2 mb-2">无笔记</small>
        </div>
    {% endif %}
</div>
 
<!-- 弹出式工具栏 -->
<div class="offcanvas offcanvas-bottom" data-bs-focus="false" style="height: 50%;" tabindex="-1" id="toolbarBottom">
    <div class="offcanvas-header row border-bottom d-flex justify-content-between">
        <h4 class="offcanvas-title col-10" id="toolbarBottomLabel"><i class="bi bi-journal-text text-success"></i> {{ directory.name }}</h4>
        <button type="button" class="btn-close me-3" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="container">
            <div class="row mb-3">
                <div class="col-3 ps-1 pe-1">
                    <a href="#modal_new_directory " data-bs-toggle="modal" class="card pt-2 pb-2 text-center text-success">
                        <i class="bi bi-journal-plus" style="font-size: 2rem;"></i>
                        <small>子目录</small>
                    </a>
                </div>
                <div class="col-3 ps-1 pe-1">
                    <a href="#modal_move_directory" data-bs-toggle="modal" class="card pt-2 pb-2 text-center text-primary">
                        <i class="bi bi-pin-map" style="font-size: 2rem;"></i>
                        <small>移动</small>
                    </a>
                </div>
                <div class="col-3 ps-1 pe-1">
                    <a href="#" class="card pt-2 pb-2 text-center text-secondary">
                        <i class="bi bi-grid-1x2" style="font-size: 2rem;"></i>
                        <small>*视图*</small>
                    </a>
                </div>
                <div class="col-3 ps-1 pe-1">
                    <a href="#modal_delete_confirm" data-bs-toggle="modal" class="card pt-2 pb-2 text-center text-danger">
                        <i class="bi bi-trash-fill" style="font-size: 2rem;"></i>
                        <small>删除</small>
                    </a>
                </div>
            </div>
            <ul class="list-group">
                <div class="list-group-item">
                    <div class="d-flex justify-content-between text-success">
                        <small>目录描述：<br></small>
                        <a href="#modal_change_discription" data-bs-toggle="modal" class="bi bi-pen"></a>
                    </div>
                    {% if directory.discription %}{{ directory.discription }}
                    {% else %}<span class="text-secondary">无</span>
                    {% endif %}
                </div>
            </ul>
        </div>
    </div>
</div>

<!-- 修改目录描述弹出框 -->
<div class="modal fade" id="modal_change_discription" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">修改目录描述</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'api_Notebook_directory_change_discription' directory.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="col mb-3">
                        <textarea placeholder="描述上限200字" id="form_new_directory_discription" class="form-control" name="directory_discription" type="text" maxlength="200"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" type="submit">确认</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 确认删除目录弹出框 -->
<div class="modal fade" id="modal_delete_confirm" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">确认删除？</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                所有子目录和笔记都将被删除。
            </div>
            <div class="modal-footer">
                <a class="btn btn-danger" href="{% url 'api_Notebook_directory_delete' directory.id %}">确认</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 新子目录弹出框 -->
<div class="modal fade" id="modal_new_directory" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">创建子目录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                <div class="container">
                    <form id="form_new_directory" method="post" action="{% url 'api_Notebook_directory_new_save' directory.id %}">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="col mb-3">
                                <label class="form-label"><span class="text-danger">*</span> 目录名</label>
                                <input id="form_new_directory_name" class="form-control" name="directory_name" type="text" maxlength="20" required>
                            </div>
                            <div class="col mb-3">
                                <label class="form-label">目录描述 <i class="text-success bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="如《英文》目录的描述可以是：“包含语法、单词、习惯用语等内容”"></i></label>
                                <input id="form_new_directory_discription" class="form-control" name="directory_discription" type="text" maxlength="200">
                            </div>
                            {% if directory.first_child %}
                                <label class="form-label">
                                    <span class="text-danger">*</span> 新目录位置（点击<i class="bi bi-plus align-self-center text-success"></i>确定插入点）：<span id="isFormFilled" class="text-danger">未选择</span></label>
                                <div class="container mb-3">
                                    <div class="row mt-3">
                                        <ul class="list-group list-group-flush">
                                            {% with dir=directory.first_child %}
                                                <a id="insertDir_{{directory.id}}_{{dir.id}}" href="#" class="list-group-item list-group-item-action d-flex justify-content-start" style="height: 20px;">
                                                    <i class="bi bi-plus align-self-center" style="font-size: 0.75rem;"><span class="invisible align-self-center"> 在此处添加新目录</span></i>
                                                </a>                                            
                                                {% include 'Notebook/directory/notelist_new_subdir_tree.html' with dir=dir %}
                                            {% endwith%}
                                        </ul>
                                    </div>
                                </div>
                            {% endif %}
                            <input id="form_new_directory_position" class="invisible" name="directory_position" type="text" {% if directory.first_child %}required {% else %}value='insertDir_{{directory.id}}__left'{% endif %}>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" type="submit" href="#">确认</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        </div>
                    </form>
                </div>
        </div>
    </div>
</div>

<!-- 移动目录弹出框 -->
<div class="modal fade" id="modal_move_directory" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered ">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">挂载到新位置：<span class="bi-arrow-bar-right text-success"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row mt-3">
                        <div class="col">
                            <ul class="list-group list-group-flush">
                                {% if root_dir.first_child %}
                                    {% with dir=root_dir.first_child dir_to_move=directory %}
                                        {% if dir == dir_to_move %}
                                            <div class="list-group-item d-flex justify-content-between">
                                                <span class="col-12"><i class="bi bi-journal-bookmark-fill"></i> {{ dir_to_move.name }} <span class="text-danger">*当前所在位置*</span></span>
                                            </div>
                                            {% if dir_to_move.next_brother %}
                                                {% include 'Notebook/directory/notelist_move_dir.html' with dir=dir_to_move.next_brother %}
                                            {% endif %}
                                        {% else %}
                                            <a href="{% url 'api_Notebook_move_directory' dir_to_move.id root_dir.id dir.id 0 %}" class="list-group-item list-group-item-action d-flex justify-content-start move-dir" style="height: 18px;">
                                                <i class="bi bi-arrow-bar-right align-self-center" style="font-size: 0.75rem;"></i>
                                            </a>
                                            {% include 'Notebook/directory/notelist_move_dir.html' with dir=dir dir_to_move=directory %}
                                        {% endif %}
                                    {% endwith%}
                                {% else %}
                                    ？你怎么进来的
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 底部工具栏 -->
<div class="fixed-bottom border-top">
    <nav class="navbar navbar-light bg-light">
        <span class="col-2"></span>
        {% with lengthof_notes_not_pintop=notes_not_pintop|length %}
            <small class="col-8 text-center">共{{ notes_pintop|length|add:lengthof_notes_not_pintop }}条笔记</small>
        {% endwith %}
        <a href="{% url 'Notebook_note_new' directory.id %}" class="text-success bi bi-pencil-square text-center col-2" style="font-size: 1.5rem;"></a>
    </nav>
</div>

{% endblock %}

{% block block_js%}
<script src="{% static '/jquery/jquery.min.js' %}"></script>
<script src="{% static '/bootstrap/js/popover.js' %}"></script>
<script src="{% static '/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static '/Notebook/js/directory_change_position.js' %}"></script>
<script src="{% static '/Notebook/js/directory_new.js' %}"></script>
{% endblock %}